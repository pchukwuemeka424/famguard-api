<?php
// Include configuration
require_once 'config.php';

// Set content type
header('Content-Type: text/html; charset=utf-8');
%>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Inspector - FamGuard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        h2 {
            color: #667eea;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 22px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .error {
            background-color: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #fcc;
        }
        
        .success {
            background-color: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #cfc;
        }
        
        .info {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #90caf9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .table-name {
            font-weight: 600;
            color: #667eea;
        }
        
        .column-name {
            font-weight: 500;
            color: #333;
        }
        
        .data-type {
            color: #666;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .nullable {
            color: #999;
            font-style: italic;
        }
        
        .sample-data {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .count {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Database Inspector</h1>
        
        <?php
        try {
            // Connect to database
            $pdo = getDatabaseConnection();
            
            echo '<div class="success">✓ Successfully connected to database</div>';
            
            // Get all tables
            echo '<h2>Available Tables</h2>';
            $tablesQuery = "SELECT table_name 
                          FROM information_schema.tables 
                          WHERE table_schema = 'public' 
                          AND table_type = 'BASE TABLE'
                          ORDER BY table_name";
            $tablesStmt = $pdo->query($tablesQuery);
            $tables = $tablesStmt->fetchAll();
            
            if (empty($tables)) {
                echo '<div class="info">No tables found in the database.</div>';
            } else {
                echo '<table>';
                echo '<tr><th>Table Name</th><th>Row Count</th></tr>';
                
                foreach ($tables as $table) {
                    $tableName = $table['table_name'];
                    
                    // Get row count
                    $countStmt = $pdo->query("SELECT COUNT(*) as count FROM \"$tableName\"");
                    $count = $countStmt->fetch()['count'];
                    
                    echo '<tr>';
                    echo '<td class="table-name">' . htmlspecialchars($tableName) . '</td>';
                    echo '<td>' . number_format($count) . ' rows</td>';
                    echo '</tr>';
                }
                echo '</table>';
            }
            
            // Get table structure for each table
            foreach ($tables as $table) {
                $tableName = $table['table_name'];
                
                echo "<h2>Table: <span class=\"table-name\">$tableName</span></h2>";
                
                // Get column information
                $columnsQuery = "SELECT 
                    column_name,
                    data_type,
                    character_maximum_length,
                    is_nullable,
                    column_default
                FROM information_schema.columns
                WHERE table_schema = 'public' 
                AND table_name = :table_name
                ORDER BY ordinal_position";
                
                $columnsStmt = $pdo->prepare($columnsQuery);
                $columnsStmt->execute(['table_name' => $tableName]);
                $columns = $columnsStmt->fetchAll();
                
                if (!empty($columns)) {
                    echo '<table>';
                    echo '<tr>';
                    echo '<th>Column Name</th>';
                    echo '<th>Data Type</th>';
                    echo '<th>Nullable</th>';
                    echo '<th>Default Value</th>';
                    echo '</tr>';
                    
                    foreach ($columns as $column) {
                        $dataType = $column['data_type'];
                        if ($column['character_maximum_length']) {
                            $dataType .= '(' . $column['character_maximum_length'] . ')';
                        }
                        
                        echo '<tr>';
                        echo '<td class="column-name">' . htmlspecialchars($column['column_name']) . '</td>';
                        echo '<td class="data-type">' . htmlspecialchars($dataType) . '</td>';
                        echo '<td>' . ($column['is_nullable'] === 'YES' ? '<span class="nullable">YES</span>' : 'NO') . '</td>';
                        echo '<td>' . ($column['column_default'] ? htmlspecialchars($column['column_default']) : '-') . '</td>';
                        echo '</tr>';
                    }
                    echo '</table>';
                }
                
                // Get sample data (first 5 rows)
                echo '<h3>Sample Data (First 5 Rows)</h3>';
                $sampleStmt = $pdo->query("SELECT * FROM \"$tableName\" LIMIT 5");
                $sampleData = $sampleStmt->fetchAll();
                
                if (!empty($sampleData)) {
                    echo '<table>';
                    // Header
                    echo '<tr>';
                    foreach (array_keys($sampleData[0]) as $column) {
                        echo '<th>' . htmlspecialchars($column) . '</th>';
                    }
                    echo '</tr>';
                    
                    // Data rows
                    foreach ($sampleData as $row) {
                        echo '<tr>';
                        foreach ($row as $value) {
                            $displayValue = $value === null ? '<span class="nullable">NULL</span>' : htmlspecialchars($value);
                            echo '<td class="sample-data" title="' . htmlspecialchars($value ?? '') . '">' . $displayValue . '</td>';
                        }
                        echo '</tr>';
                    }
                    echo '</table>';
                } else {
                    echo '<div class="info">No data in this table.</div>';
                }
            }
            
            // Check if users table exists and has email column
            echo '<h2>Account Deletion Compatibility Check</h2>';
            $usersTableExists = false;
            $emailColumnExists = false;
            
            foreach ($tables as $table) {
                if (strtolower($table['table_name']) === 'users' || strtolower($table['table_name']) === 'user') {
                    $usersTableExists = true;
                    $actualTableName = $table['table_name'];
                    
                    // Check for email column
                    $emailCheckStmt = $pdo->prepare($columnsQuery);
                    $emailCheckStmt->execute(['table_name' => $actualTableName]);
                    $emailColumns = $emailCheckStmt->fetchAll();
                    
                    foreach ($emailColumns as $col) {
                        if (strtolower($col['column_name']) === 'email') {
                            $emailColumnExists = true;
                            break;
                        }
                    }
                    break;
                }
            }
            
            if ($usersTableExists && $emailColumnExists) {
                echo '<div class="success">✓ Compatible table found! The delete_account.php script should work correctly.</div>';
            } else {
                echo '<div class="error">⚠ Warning: No compatible table found for account deletion.</div>';
                if (!$usersTableExists) {
                    echo '<div class="info">• No table named "users" or "user" found. Please update USERS_TABLE in config.php to match your actual table name.</div>';
                }
                if ($usersTableExists && !$emailColumnExists) {
                    echo '<div class="info">• The users table exists but does not have an "email" column. Please check your table structure.</div>';
                }
            }
            
        } catch (PDOException $e) {
            echo '<div class="error">';
            echo '<strong>Database Connection Error:</strong><br>';
            echo htmlspecialchars($e->getMessage());
            echo '</div>';
        } catch (Exception $e) {
            echo '<div class="error">';
            echo '<strong>Error:</strong><br>';
            echo htmlspecialchars($e->getMessage());
            echo '</div>';
        }
        %>
    </div>
</body>
</html>

