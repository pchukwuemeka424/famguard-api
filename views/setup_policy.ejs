<?php
// Include configuration
require_once 'config.php';

// Set content type
header('Content-Type: text/html; charset=utf-8');
%>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Delete Policy - FamGuard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .sql-code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 15px 0;
            line-height: 1.6;
        }
        
        .sql-code .keyword {
            color: #c678dd;
        }
        
        .sql-code .string {
            color: #98c379;
        }
        
        .sql-code .comment {
            color: #5c6370;
            font-style: italic;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .step {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .step h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Setup Delete Policy</h1>
        <p class="subtitle">Configure Row Level Security (RLS) policies for user account deletion</p>
        
        <?php
        $errors = [];
        $successes = [];
        $warnings = [];
        $info = [];
        
        try {
            // Connect to database
            $pdo = getDatabaseConnection();
            
            // Check if users table exists
            $tableCheck = $pdo->query("SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_schema = 'public' 
                AND table_name = '" . USERS_TABLE . "'
            )");
            $tableExists = $tableCheck->fetchColumn();
            
            if (!$tableExists) {
                $errors[] = "Table '" . USERS_TABLE . "' does not exist. Please create it first or update USERS_TABLE in config.php";
            } else {
                $info[] = "Table '" . USERS_TABLE . "' found.";
                
                // Check if RLS is enabled
                $rlsCheck = $pdo->query("SELECT relrowsecurity FROM pg_class WHERE relname = '" . USERS_TABLE . "'");
                $rlsEnabled = $rlsCheck->fetchColumn();
                
                if (!$rlsEnabled) {
                    // Enable RLS
                    try {
                        $pdo->exec("ALTER TABLE " . USERS_TABLE . " ENABLE ROW LEVEL SECURITY");
                        $successes[] = "Row Level Security (RLS) has been enabled on the '" . USERS_TABLE . "' table.";
                    } catch (PDOException $e) {
                        $errors[] = "Failed to enable RLS: " . $e->getMessage();
                    }
                } else {
                    $info[] = "Row Level Security (RLS) is already enabled on the '" . USERS_TABLE . "' table.";
                }
                
                // Check if delete policy already exists
                $policyCheck = $pdo->prepare("SELECT EXISTS (
                    SELECT 1 FROM pg_policies 
                    WHERE schemaname = 'public' 
                    AND tablename = :table_name 
                    AND policyname = 'allow_delete_by_email'
                )");
                $policyCheck->execute(['table_name' => USERS_TABLE]);
                $policyExists = $policyCheck->fetchColumn();
                
                if ($policyExists) {
                    // Drop existing policy first
                    try {
                        $pdo->exec("DROP POLICY IF EXISTS allow_delete_by_email ON " . USERS_TABLE);
                        $warnings[] = "Existing policy 'allow_delete_by_email' was removed.";
                    } catch (PDOException $e) {
                        $errors[] = "Failed to drop existing policy: " . $e->getMessage();
                    }
                }
                
                // Create delete policy
                // Policy 1: Allow users to delete their own account by email
                try {
                    $policySql = "CREATE POLICY allow_delete_by_email ON " . USERS_TABLE . "
                        FOR DELETE
                        USING (true)";
                    
                    $pdo->exec($policySql);
                    $successes[] = "Delete policy 'allow_delete_by_email' created successfully. This allows deletion of any user record (for account deletion functionality).";
                } catch (PDOException $e) {
                    $errors[] = "Failed to create delete policy: " . $e->getMessage();
                }
                
                // Optional: Create a more restrictive policy that only allows users to delete their own account
                // This requires authentication context, which might not be available in your setup
                // Uncomment if you have user authentication in place
                /*
                try {
                    $pdo->exec("CREATE POLICY allow_delete_own_account ON " . USERS_TABLE . "
                        FOR DELETE
                        USING (auth.uid()::text = id::text)");
                    $successes[] = "Restrictive delete policy created (users can only delete their own account).";
                } catch (PDOException $e) {
                    $warnings[] = "Could not create restrictive policy (this is normal if auth is not set up): " . $e->getMessage();
                }
                */
            }
            
        } catch (PDOException $e) {
            $errors[] = "Database error: " . $e->getMessage();
        } catch (Exception $e) {
            $errors[] = "Error: " . $e->getMessage();
        }
        
        // Display messages
        foreach ($errors as $error) {
            echo '<div class="alert alert-error">❌ ' . htmlspecialchars($error) . '</div>';
        }
        
        foreach ($warnings as $warning) {
            echo '<div class="alert alert-warning">⚠️ ' . htmlspecialchars($warning) . '</div>';
        }
        
        foreach ($info as $infoMsg) {
            echo '<div class="alert alert-info">ℹ️ ' . htmlspecialchars($infoMsg) . '</div>';
        }
        
        foreach ($successes as $success) {
            echo '<div class="alert alert-success">✓ ' . htmlspecialchars($success) . '</div>';
        }
        
        if (empty($errors) && !empty($successes)) {
            echo '<div class="step">';
            echo '<h3>Policy Setup Complete!</h3>';
            echo '<p>The delete policy has been successfully configured. Your <code>delete_account.php</code> script should now work correctly.</p>';
            echo '<a href="delete_account.php" class="btn">Test Account Deletion</a>';
            echo '</div>';
        }
        %>
        
        <div class="step">
            <h3>What was configured?</h3>
            <p>The following SQL commands were executed:</p>
            <div class="sql-code">
<span class="comment">-- Enable Row Level Security</span>
<span class="keyword">ALTER TABLE</span> <%= USERS_TABLE; %> <span class="keyword">ENABLE ROW LEVEL SECURITY</span>;

<span class="comment">-- Create delete policy (allows deletion by email)</span>
<span class="keyword">CREATE POLICY</span> allow_delete_by_email <span class="keyword">ON</span> <%= USERS_TABLE; %>
    <span class="keyword">FOR DELETE</span>
    <span class="keyword">USING</span> (<span class="keyword">true</span>);
            </div>
        </div>
        
        <div class="step">
            <h3>Policy Details</h3>
            <p><strong>Policy Name:</strong> allow_delete_by_email</p>
            <p><strong>Table:</strong> <%= USERS_TABLE; %></p>
            <p><strong>Operation:</strong> DELETE</p>
            <p><strong>Rule:</strong> Allows deletion of any row (for account deletion via email)</p>
            <p class="alert alert-warning" style="margin-top: 15px;">
                <strong>Note:</strong> This policy allows deletion of any user record. If you need more restrictive access control (e.g., users can only delete their own account), you'll need to implement authentication and modify the policy accordingly.
            </p>
        </div>
        
        <div class="step">
            <h3>Verify Policy</h3>
            <p>You can verify the policy was created by running this query in your Supabase SQL editor:</p>
            <div class="sql-code">
<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pg_policies 
<span class="keyword">WHERE</span> tablename = <span class="string">'<%= USERS_TABLE; %>'</span>;
            </div>
        </div>
    </div>
</body>
</html>

